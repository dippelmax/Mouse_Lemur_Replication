---
title: "R Replication Assignment"
author: "Max Dippel"
date: "11/16/2021"
output: html_document
---

## Description of Assignment

<br> 

Today, I will be discussing my attempts to replicate "The role of nocturnal omnivorous lemurs as seed dispersers in Malagasy rain forests" by Ramananjato et al. published in biotropica in 2020. First though, I would like to mention that I had meant to discuss another study with you all today. This paper, "Crop Feeding by Brown Howlers (*Alouatta guariba clamitans*) in Forest Fragments: The Conservation Value of Cultivated Species" by Oscar Chaves and Julio Cesar Bicca-Marques, proved difficult to replicate for a variety of reasons. The study was the analysis of the fruits howler monkeys ate of different species in three different orchards. However, the data set did not include the basal area of each species within each orchard making it impossible to calculate the fruit avalibility index of each species. Secondly, a link in the study to the market value of each fruit species was no longer operational. This made it impossible to calculate the economic value of the fruit which was lost due to the crop feeding. 

<br> 

So, I moved on to the next paper anticipating less problems. The paper Ramananjato et al. 2020 analyzes the role of two species of mouse lemur, *Microcebus rufus* and *Microcebus jollyae*, in seed dispersal in Madagascar's forest. The researchers collected seeds which had been defecated by mouse lemurs and seeds which had fallen on the ground them subjected them to various growth experiments. For *Microcebus rufus*, one experiment looked at seed growth in a petri dish setting and the other looked at seed growth on the forest ground. For *Microcebus jollyae*, experiments were conducted in a petri dish, in a semi-shaded plot and a shaded plot. From these experiments, the researchers compared germination rate, germination time and seedling length after a certain period of time between defecated and control seeds using mixed effect models and survival analysis. 


## Data set-up


First load the packages. There are quite a lot of them for this analysis.

```{r echo=T, results='hide', message=FALSE,}
library(lme4)
library(ggplot2)
library(ggfortify)
library(Hmisc)
library(ggpubr)
library(MuMIn)
library(tidyverse)
library(survival)
```

Loading the data into R the first step of the analysis. This was more complicated than I intially realized because every numerical variable was actually loaded in as a factor When attempted to graph the results or run models, the results would have an error or not look as it should have. I used as.numeric to create new numeric varaibles in the data set which the R could read easily. 

```{r echo=T, results='hide', warning=FALSE}
data <- read.csv("mouse_lemur_data.csv", header = TRUE)
data$species_number <- as.numeric(as.factor(data$scientificName))
data$seedling_mm <- as.numeric(data$seedling_length_mm)
data$germ_time <- as.numeric(data$germination_time)
data$ratio <- as.numeric( factor(data$germination_state) ) - 1
```

Subsetting the data into something workable based on the experiment and then only the seeds which germinated. This is where we can begin to see that the data set I have is not the data set which is presented in the paper. The number of observations is incorrect in many cases. 

First I will subset the data for seeds dispersed by *Microcebus rufus*

```{r}
# Subsetting the data to only include seeds dispersed by microcebus rufus
rufus <- subset(data, disperser == "microcebus_rufus")
# Subsetting the data to only include seeds dispersed by microcebus rufus in the petri dish experiment
rufus_petri <- subset(rufus, experiment == "Petri dish")
nrow(rufus_petri)
# The number of total observations in the experiment is 685
# Now, I am subsettung the data to only have seeds which germinated 
rufus_petri_yes <- subset(rufus_petri, germination_state == "yes")
nrow(rufus_petri_yes)
# The number of germinated seeds is 121
```


```{r echo=T, results='hide'}
# This creates summary statistics for seedling growth for each species
rufus_petri_yes_summary <- rufus_petri_yes %>% 
  group_by(scientificName, treatment) %>%
  summarise(seedling_mean = mean(seedling_mm),
            N = n())
####  This line modifies the summary statistics to include only the species for which there is a defecated and control. This step was not explicitly stated anywhere in the paper and it took me a very long time to figure it out.   
rufus_petri_yes_summary_modified <- rufus_petri_yes_summary[-c(3, 4, 5, 6, 7, 12), ]
sum(rufus_petri_yes_summary_modified$N)
# 88
```
<br>

The number of total observations in the experiment is 685. The number of observations germinated is 121. The number of observations after only including species with defecated and control seeds is 88. However, the paper states 150 is total sample size and 88 observations are actually analyzed. 

In this case, the researchers seemed to have used the final summary (n=88) for the number of observations actually analyzed (n=88). Concerningly, I do not know where the number 150 as the total number of observations comes from. 

<br>
```{r}
# Subsetting the data to only include seeds dispersed by microcebus rufus in the forest ground experiment
rufus_ground <- subset(rufus, experiment == "Forest ground")
nrow(rufus_ground)
# The number of total observations in the experiment is 231
# Now, I am subsettung the data to only have seeds which germinated
rufus_ground_yes <- subset(rufus_ground, germination_state == "yes")
nrow(rufus_ground_yes)
#The number of germinated seeds is 7
```

This experiment does not need a filtering for only species with defecated and control seeds because they are all the same species

The number of total observations in experiment is 231. The number of observations germinated is 7. The umber of observations after only including species with defecated and control seeds is 7 (they are all the same species). However, the paper states 75 is total sample size and 7 are actually analyzed. 

The researchers seemed to have used the final summary (n=7) for the number of observations actually analyzed (n=7). Concerningly, I have no idea where the number 75 as the total number of observations comes from. 

<br>

Now, I will subset the data for seeds dispersed by *Microcebus jollyae*

```{r}
# Subsetting the data to only include seeds dispersed by microcebus jollyae
jollyae <- subset(data, disperser == "microcebus_jollyae")
# Subsetting the jollyae data to only include seeds in the petri dish experiment
jollyae_petri <- subset(jollyae, experiment == "Petri dish")
nrow(jollyae_petri)
# The number of total observations in the experiment is 528
# Now, I am subsettung the data to only have seeds which germinated 
jollyae_petri_yes <- subset(jollyae_petri, germination_state == "yes")
nrow(jollyae_petri_yes)
# The number of germinated seeds is 70
```

```{r}
# This creates summary statistics for seedling growth for each species
jollyae_petri_yes_summary <- jollyae_petri_yes %>% 
  group_by(scientificName, treatment) %>%
  summarise(seedling_mean = mean(seedling_mm), germ_time = mean(germ_time),
            N = n())
####  This line modifies the summary statistics to include only the species for which there is a defecated and control  
jollyae_petri_yes_summary_modified <- jollyae_petri_yes_summary[-c(1, 2, 3), ]
jollyae_petri_yes_summary_modified
sum(jollyae_petri_yes_summary_modified$N)
# 25
```

The number of total observations in the experiment is 528. The number of observations germinated is 70. The number of observations after only including species with defecated and control seeds is 25. However, the paper states 528 is total sample size and 70 observations are actually analyzed. 

In this case, the researchers seemed to have used all of the observations germinated (n=70) for the number of observations actually analyzed (n=70)

```{r}
# Subsetting the jollyae data to only include seeds in the shaded plot experiment
jollyae_closed <- subset(jollyae, experiment == "Closed")
nrow(jollyae_closed)
# 694
jollyae_closed_yes <- subset(jollyae_closed, germination_state == "yes")
nrow(jollyae_closed_yes)
# 61
```


```{r}
# This creates summary statistics for seedling growth for each species
jollyae_closed_yes_summary <- jollyae_closed_yes %>% 
  group_by(scientificName, treatment) %>%
  summarise(seedling_mean = mean(seedling_mm), germ_time = mean(germ_time),
            N = n())
# This line modifies the summary statistics to include only the species for which there is a defecated and control  
jollyae_closed_yes_summary_modified <- jollyae_closed_yes_summary[-c(5, 6), ]
jollyae_closed_yes_summary_modified
sum(jollyae_closed_yes_summary_modified$N)
#43
```

The number of total observations in the experiment is 694. The number of observations germinated is 61. The number of observations after only including species with defecated and control seeds is 43. However, the paper states 377 is total sample size and 47 observations are actually analyzed. 

In this case, the researchers seemed to have added the 4 seeds from	*voampoalahy* from the final summary (n=43) to make the number of observations analyzed (n=47)

Concerningly, I do not know where the number 377 as the total observations in the experiment comes from

```{r}
# Subsetting the jollyae data to only include seeds in the semi-shaded plot experiment
jollyae_semi <- subset(jollyae, experiment == "Semi-closed")
nrow(jollyae_semi)
# 660
jollyae_semi_yes <- subset(jollyae_semi, germination_state == "yes")
nrow(jollyae_semi_yes)
# 233
```

```{r}
# This creates summary statistics for seedling growth for each species
jollyae_semi_yes_summary <- jollyae_semi_yes %>% 
  group_by(scientificName, treatment) %>%
  summarise(seedling_mean = mean(seedling_mm), germ_time = mean(germ_time),
            N = n())
####  This line modifies the summary statistics to include only the species for which there is a defecated and control  
jollyae_semi_yes_summary_modified <- jollyae_semi_yes_summary
jollyae_semi_yes_summary_modified
sum(jollyae_semi_yes_summary_modified$N)
#233
```

The number of total observations in the experiment is 660. The number of observations germinated is 233. The number of observations after only including species with defecated and control seeds is 233. However, the paper states 660 is total sample size and 233 observations are actually analyzed. 

The researchers seemed to have used the final summary (n=233) for the number of observations actually analyzed (n=233). There were no single experiment species so there are no differences between the number germinated and the final summary. 

<br><br><br>

## Violin graphs
This is the violin first graph of the *Microcebus rufus* petri dish experiment

```{r}

ggplot(data = rufus_petri_yes, aes(x = treatment, y = seedling_mm)) +
  geom_point() + theme_bw() + geom_violin( aes(colour = treatment, fill = treatment)) +
  stat_summary(fun = mean, geom="point", shape=23, size=5, fill = "black") +
  labs(title = "Microcebus rufus",subtitle = "Petri dish", 
       y = "mean seedling length (mm)", x = "Treatment") +
  theme(plot.title = element_text(face = "italic")) + 
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  scale_color_manual(values=c("darkgreen", "darkorange3")) +
  scale_fill_manual(values=c("darkgreen", "darkorange3")) + 
  theme(legend.position = "None")

# This caption is to be added later using word (as done in the original study)
#  N = 37(75) 51(75) 
```

Here is the original figure

![*Microcebus rufus violin graph*](../Mouse_Lemur_Replication/Microcebus_rufus_violin_graph.png){width=500px}

There are few differences between the replicated graph and the original graph. 

Next I will graph the seedling length for each experiment done with seeds dispersed by *Microcebus jollyae*. This second graph is a series of three violin graphs together. It is complete with axis labels, a title and subtitles. I had to go through a lot of work to hide the y axis on two of them so that they would all fit together without excess information. 

```{r}
# First we have the Petri dish experiment
plot1 <- ggplot(data = jollyae_petri_yes, aes(x = treatment, y = seedling_mm)) +
   theme_bw() + geom_violin( aes(colour = treatment, fill = treatment)) +
  stat_summary(fun = mean, geom="point", shape=23, size=5, fill = "black") + 
  ylim(0,50) + 
  labs(title = "Microcebus jollyae",subtitle = "Petri dish", 
       y = "mean seedling length (mm)", x = "Treatment") +
  theme(plot.title = element_text(face = "italic")) + 
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  scale_color_manual(values=c("darkgreen", "darkorange3")) +
  scale_fill_manual(values=c("darkgreen", "darkorange3")) + 
  theme(legend.position = "None")
# Next we have the semi-shaded plots
plot2 <- ggplot(data = jollyae_semi_yes, aes(x = treatment, y = seedling_mm)) +
   theme_bw() + geom_violin( aes(colour = treatment, fill = treatment)) +
  stat_summary(fun = mean, geom="point", shape=23, size=5, fill = "black") +
  ylim(0,50) +
  labs(title = "",subtitle = "Semi-shaded", 
       y = "mean seedling length (mm)", x = "Treatment") +
  theme(plot.title = element_text(face = "italic")) + 
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  scale_color_manual(values=c("darkgreen", "darkorange3")) +
  scale_fill_manual(values=c("darkgreen", "darkorange3")) + 
  theme(legend.position = "None") + 
  theme(axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(), 
        axis.title.y = element_blank())
# Then we have the shaded plots
plot3 <- ggplot(data = jollyae_closed_yes, aes(x = treatment, y = seedling_mm)) +
  theme_bw() + geom_violin( aes(colour = treatment, fill = treatment)) +
  stat_summary(fun = mean, geom="point", shape=23, size=5, fill = "black") +
  ylim(0,50) +
  labs(title = "",subtitle = "Shaded", 
       y = "mean seedling length (mm)", x = "Treatment") +
  theme(plot.title = element_text(face = "italic")) + 
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  scale_color_manual(values=c("darkgreen", "darkorange3")) +
  scale_fill_manual(values=c("darkgreen", "darkorange3")) + 
  theme(legend.position = "None") + 
  theme(axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(), 
        axis.title.y = element_blank())
# Now I will add them together
ggarrange(plot1, plot2, plot3, ncol = 3, nrow = 1)

# Just like the first graph, a caption is to be added later using word (as done in the original study)
```

Here is the original figure 

![*Microcebus jollyae* violin graph](../Mouse_Lemur_Replication/Triple_violin_graph.png){width=500px}

This replicated figure is quite different from the original. 

<br><br><br>

## Mixed Effects Models Analysis


## Survival analysis


This is the survival analysis for seeds dispersed by microcebus rufus in the petri dish experiment 

```{r}
# Creating a status colum to indicate that all of the seeds germinated at some point
rufus_petri_yes$status <- rep(1, times = 121, length.out = NA, each = 1)

# Next we use the survival function to make a survival curve 
rufus_petri_yes_km_fit <- survfit(Surv(germ_time, status) ~ treatment, data = rufus_petri_yes)
# This give a nice summary of the analysis
summary(rufus_petri_yes_km_fit, times = c(1,15,30,45,60,75,90))
```

```{r}
# Next we plot the survival fit and make it look like the graph in the paper
rufus_petri_yes_km_plot <- autoplot(rufus_petri_yes_km_fit) 
rufus_petri_yes_km_plot + labs(title = "Microcebus rufus",subtitle = "Petri dish experiment", 
                           y = "Probability of germinating", x = "Time (days)") +
  theme(plot.title = element_text(face = "italic")) +
  scale_color_manual(values=c("darkgreen", "darkorange3")) +
  scale_fill_manual(values=c("darkgreen", "darkorange3")) + 
  geom_text(x=75, y=.2, label="p < 0.0001") + theme(legend.position="bottom")
```

One problem though is that this graph is upside down. I used scale_y_reverse() to reverse the scale, but now the numbers are wrong and the annotated p value is gone.

```{r}
rufus_petri_yes_km_plot + labs(title = "Microcebus rufus",subtitle = "Petri dish experiment", 
                               y = "Probability of germinating", x = "Time (days)") +
  theme(plot.title = element_text(face = "italic")) +
  scale_color_manual(values=c("darkgreen", "darkorange3")) +
  scale_fill_manual(values=c("darkgreen", "darkorange3")) + 
  geom_text(x=75, y=.75, label="p < 0.0001") + theme(legend.position="bottom") + scale_y_reverse()
```

Here is the original graph 

![*Microcebus rufus* survival graph for the petri dish experiment ](../Mouse_Lemur_Replication/Survival_rufus_petri_graph.png){width=500px} 

This the the Cox test with fragility. The summary includes the Chi square value, the degrees of freedom and the p-value. 

```{r}
rufus_petri_yes_cox <- coxph(Surv(germ_time, status) ~ treatment, data=rufus_petri_yes)
summary(rufus_petri_yes_cox)
```

X^2 = 41.38
df = 1
p = 1e-10


This is the survival analysis for seeds dispersed by microcebus rufus in the forest ground experiment 

```{r}
#Creating a status colum to indicate that all of the seeds germinated at some point
rufus_ground_yes$status <- rep(1, times = 7, length.out = NA, each = 1)
# Next we use the survival function to make a survival curve 
rufus_ground_yes_km_fit <- survfit(Surv(germ_time, status) ~ 1, data = rufus_ground_yes)
# This gives a nice summary of the analysis
summary(rufus_ground_yes_km_fit, times = c(1,15,30,45,60,75,90))
```


Next we plot the survival fit and make it look like the graph in the paper
```{r}
rufus_ground_yes_km_plot <- autoplot(rufus_ground_yes_km_fit) 
rufus_ground_yes_km_plot + labs(title = "Microcebus rufus",subtitle = "Forest ground experiment", 
                               y = "Probability of germinating", x = "Time (days)") +
  theme(plot.title = element_text(face = "italic")) +
  scale_color_manual(values=c("darkorange3")) +
  scale_fill_manual(values=c("darkorange3")) + theme(legend.position="bottom")
```

Unfortunately it does not have color

One problem though is that this graph is upside down. I used scale_y_reverse() to reverse the scale, but now the numbers are wrong and the annotated p value is gone. 

```{r}
rufus_ground_yes_km_plot + labs(title = "Microcebus rufus",subtitle = "Forest ground experiment", 
                               y = "Probability of germinating", x = "Time (days)") +
  theme(plot.title = element_text(face = "italic")) +
  scale_color_manual(values=c("darkorange3")) +
  scale_fill_manual(values=c( "darkorange3")) + theme(legend.position="bottom") + scale_y_reverse()
```

Here is the original graph

![*Microcebus rufus* survival graph for the forest ground experiment ](../Mouse_Lemur_Replication/Survival_rufus_ground_graph.png){width=500px}

There is no chi square analysis for the Microcebus rufus forest ground experiment because there is only one treatment 

<br>

This is the survival analysis for seeds dispersed by microcebus jollyae in the petri dish experiment 
```{r}
# Creating a status colum to indicate that all of the seeds germinated at some point
jollyae_petri_yes$status <- rep(1, times = 70, length.out = NA, each = 1)

# Next we use the survival function to make a survival curve 
jollyae_petri_yes_km_fit <- survfit(Surv(germ_time, status) ~ treatment, data = jollyae_petri_yes)
# This give a nice summary of the analysis
summary(jollyae_petri_yes_km_fit, times = c(1,15,30,45,60,75,90))
```

Unfortunetly, it is impossible to plot this next graph. The error "Error: Aesthetics can not vary with a ribbon" makes it impossible for graph to be graphed. I researched this error and could not find the solution. 

```{r}
# jollyae_petri_yes_km_plot <- autoplot(jollyae_petri_yes_km_fit) 
# jollyae_petri_yes_km_plot
```

Here is the original graph

![*Microcebus jollyae* survival graph for the petri dish experiment ](../Mouse_Lemur_Replication/Survival_jollyae_petri_graph.png){width=500px}

This the the Cox test with fragility. The summary includes the Chi square value, the degrees of freedom and the p-value

```{r}
jollyae_petri_yes_cox <- coxph(Surv(germ_time, status) ~ treatment, data=jollyae_petri_yes)
summary(jollyae_petri_yes_cox)
```

X^2 = 0.02
df = 1
p = 0.9 

<br>

This is the survival analysis for seeds dispersed by microcebus jollyae in the semi-shaded plot experiment 
 
```{r}
# Creating a status colum to indicate that all of the seeds germinated at some point
jollyae_semi_yes$status <- rep(1, times = 233, length.out = NA, each = 1)
# Next we use the survival function to make a survival curve 
jollyae_semi_yes_km_fit <- survfit(Surv(germ_time, status) ~ treatment, data = jollyae_semi_yes)
# This give a nice summary of the analysis
summary(jollyae_semi_yes_km_fit, times = c(1,15,30,45,60,75,90))
```

```{r}
# Next we plot the survival fit and make it look like the graph in the paper
jollyae_semi_yes_km_plot <- autoplot(jollyae_semi_yes_km_fit) 
jollyae_semi_yes_km_plot + labs(title = "Microcebus jollyae",subtitle = "Semi-shaded experiment", 
                                 y = "Probability of germinating", x = "Time (days)") +
  theme(plot.title = element_text(face = "italic")) +
  scale_color_manual(values=c("darkgreen", "darkorange3")) +
  scale_fill_manual(values=c("darkgreen", "darkorange3")) + 
  geom_text(x=75, y=.2, label="p = 0.2") + theme(legend.position="bottom")
```

One problem though is that this graph is upside down. I used scale_y_reverse() to reverse the scale, but now the numbers are wrong and the annotated p value is gone. 

```{r}
jollyae_semi_yes_km_plot + labs(title = "Microcebus jollyae",subtitle = "Semi-shaded experiment", 
                                 y = "Probability of germinating", x = "Time (days)") +
  theme(plot.title = element_text(face = "italic")) +
  scale_color_manual(values=c("darkgreen", "darkorange3")) +
  scale_fill_manual(values=c("darkgreen", "darkorange3")) + 
  geom_text(x=75, y=.75, label="p = 0.2") + theme(legend.position="bottom") + scale_y_reverse()
```

Here is the original graph

![*Microcebus jollyae* survival graph for the semi-shaded plot experiment ](../Mouse_Lemur_Replication/Survival_jollyae_semi_graph.png){width=500px} 

This the the Cox test with fragility. The summary includes the Chi square value, the degrees of freedom and the p-value.

```{r}
jollyae_semi_yes_cox <- coxph(Surv(germ_time, status) ~ treatment, data=jollyae_semi_yes)
summary(jollyae_semi_yes_cox)
```

X^2 = 1.4
df = 1
p = 0.2

<br>

This is the survival analysis for seeds dispersed by microcebus jollyae in the Shaded plot experiment 

```{r}
#Creating a status colum to indicate that all of the seeds germinated at some point
jollyae_closed_yes$status <- rep(1, times = 61, length.out = NA, each = 1)

# Next we use the survival function to make a survival curve 
jollyae_closed_yes_km_fit <- survfit(Surv(germ_time, status) ~ treatment, data = jollyae_closed_yes)
# This give a nice summary of the analysis
summary(jollyae_closed_yes_km_fit, times = c(1,15,30,45,60,75,90))
```

Next we plot the survival fit and make it look like the graph in the paper
```{r}
jollyae_closed_yes_km_plot <- autoplot(jollyae_closed_yes_km_fit) 
jollyae_closed_yes_km_plot + labs(title = "Microcebus jollyae",subtitle = "Shaded experiment", 
                                y = "Probability of germinating", x = "Time (days)") +
  theme(plot.title = element_text(face = "italic")) +
  scale_color_manual(values=c("darkgreen", "darkorange3")) +
  scale_fill_manual(values=c("darkgreen", "darkorange3")) + 
  geom_text(x=75, y=.2, label="p = .7") + theme(legend.position="bottom")
```


One problem though is that this graph is upside down. I used scale_y_reverse() to reverse the scale, but now the numbers are wrong and the annotated p value is gone. 

```{r}
jollyae_closed_yes_km_plot + labs(title = "Microcebus jollyae",subtitle = "closed-shaded experiment", 
                                y = "Probability of germinating", x = "Time (days)") +
  theme(plot.title = element_text(face = "italic")) +
  scale_color_manual(values=c("darkgreen", "darkorange3")) +
  scale_fill_manual(values=c("darkgreen", "darkorange3")) + 
  geom_text(x=75, y=.75, label="p = .7") + theme(legend.position="bottom") + scale_y_reverse()
```

This is the original graph

![*Microcebus jollyae* survival graph for the shaded plot experiment ](../Mouse_Lemur_Replication/Survival_jollyae_closed_graph.png){width=500px}

This the the Cox test with fragility. The summary includes the Chi square value, the degrees of freedom and the p-value.

```{r}
jollyae_closed_yes_cox <- coxph(Surv(germ_time, status) ~ treatment, data=jollyae_closed_yes)
summary(jollyae_closed_yes_cox)
```

X^2 = 0.17
df = 1
p = .7


<br>

